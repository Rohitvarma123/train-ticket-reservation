name: Full CI-CD Pipeline (Backend + Frontend)

on:
  push:
    branches: ["main"]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:

    # ---------------- CHECKOUT CODE ----------------
    - name: Checkout Repository
      uses: actions/checkout@v3

    # ---------------- AWS AUTHENTICATION ----------------
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1

    # ---------------- LOGIN TO ECR ----------------
    - name: Login to ECR
      run: |
        aws ecr get-login-password --region ap-northeast-1 \
        | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com


    # ==========================================================
    #                      BACKEND
    # ==========================================================
    - name: Build Backend Image
      run: |
        docker build -t backend ./backend

    - name: Tag Backend Image
      run: |
        docker tag backend:latest \
        ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com/my-backend:latest

    - name: Push Backend Image
      run: |
        docker push \
        ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com/my-backend:latest


    # ==========================================================
    #                      FRONTEND
    # ==========================================================
    - name: Build Frontend Image
      run: |
        docker build -t frontend ./frontend

    - name: Tag Frontend Image
      run: |
        docker tag frontend:latest \
        ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com/my-frontend:latest

    - name: Push Frontend Image
      run: |
        docker push \
        ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com/my-frontend:latest


    # ==========================================================
    #                   INSTALL KUBECTL
    # ==========================================================
    - name: Install kubectl (Latest)
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/
        kubectl version --client


    # ==========================================================
    #                   UPDATE KUBECONFIG
    # ==========================================================
    - name: Update Kubeconfig
      run: |
        aws eks update-kubeconfig \
          --region ap-northeast-1 \
          --name my-eks-cluster


    # ==========================================================
    #                 DEPLOY TO EKS
    # ==========================================================

    # BACKEND DEPLOYMENT
    - name: Deploy Backend to EKS
      run: |
        kubectl set image deployment/deploymentbackend \
        deploymentbackend=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com/my-backend:latest
        kubectl rollout status deployment/deploymentbackend


    # FRONTEND DEPLOYMENT
    - name: Deploy Frontend to EKS
      run: |
        kubectl set image deployment/deploymentfrontend \
        deploymentfrontend=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-1.amazonaws.com/my-frontend:latest
        kubectl rollout status deployment/deploymentfrontend





        
